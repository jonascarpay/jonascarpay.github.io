<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:creator" content="@jonascarpay" />
  <meta name="dcterms.date" content="2021-07-27" />
  <meta name="description" content="A practical guide on securely managing and deploying secrets with <code>agenix</code>" />
  <meta property="og:description" content="A practical guide on securely managing and deploying secrets with <code>agenix</code>" />
  <title>Managing secrets with agenix</title>
  <meta property="og:title" content="Managing secrets with agenix" />
  <meta property="twitter:title" content="Managing secrets with agenix" />
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../style.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:creator" content="@jonascarpay" />
</head>
<body>
<div class="header">
	<a href="../index.html">&larr; Back</a>
</div>
<header id="title-block-header">
<h1 class="title">Managing secrets with <code>agenix</code></h1>
<p class="date">2021-07-27</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#example"><span class="toc-section-number">1</span> Example</a></li>
<li><a href="#age-and-agenix"><span class="toc-section-number">2</span> <code>age</code> and <code>agenix</code></a></li>
<li><a href="#usage"><span class="toc-section-number">3</span> Usage</a>
<ul>
<li><a href="#decryption-nixos-module-configuration"><span class="toc-section-number">3.1</span> Decryption: NixOS module configuration</a></li>
<li><a href="#encryption-the-agenix-cli"><span class="toc-section-number">3.2</span> Encryption: The <code>agenix</code> CLI</a></li>
</ul></li>
<li><a href="#caveats"><span class="toc-section-number">4</span> Caveats</a>
<ul>
<li><a href="#configuration"><span class="toc-section-number">4.1</span> Configuration</a></li>
<li><a href="#some-thoughts-on-security"><span class="toc-section-number">4.2</span> Some thoughts on security</a></li>
</ul></li>
</ul>
<hr />
</nav>
<p>Dealing with sensitive information in Nix is tricky. The primary concern is that Nix is insecure by default – anything Nix touches ends up in the Nix store, and the store is readable to every process and user on your computer. The second concern is that putting secrets in your configuration means that you now have to be careful about never leaking your configuration by, say, putting it in a public repo. Both of these issues become larger the larger and more distributed your infrastructure is.</p>
<p>So, how <em>do</em> you effectively manage your secrets? There are <a href="https://nixos.wiki/wiki/Comparison_of_secret_managing_schemes">many</a> proposed solutions to this issue, but I have generally found them to not be worth the hassle, and instead just manually deployed secrets to my machines. That is, until I discovered <a href="https://github.com/ryantm/agenix"><code>agenix</code></a>.</p>
<p>I can’t overstate how right <code>agenix</code> managed to get this. It requires almost no setup or overhead, and works seamlessly across multiple machines and users. We use it at <code>$work</code>, I <a href="https://github.com/jonascarpay/nix/tree/master/secrets">use it in my personal config</a>, and I have not looked back.</p>
<p>Unfortunately, I find that <a href="https://github.com/ryantm/agenix#readme">the manual</a> makes <code>agenix</code> seem more complicated than it is, and doesn’t really highlight what makes it so nice to use. So, here is <del>more evangelism for niche technologies</del> a brief, opinionated guide to <code>agenix</code>.</p>
<h1 data-number="1" id="example"><span class="header-section-number">1</span> Example</h1>
<p>First, I want to give a little taste of how <code>agenix</code> tackles this problem. As an example, let’s say we’re setting up an OpenVPN configuration:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode nix"><code class="sourceCode nixsyntax"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Option 1</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  services.openvpn.myServer.config = <span class="st">&#39;&#39;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">    auth-user-pass path/to/credentials.txt</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span>;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Option 2</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  services.openvpn.myServer.config = <span class="st">&#39;&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">    auth-user-pass </span>${./path/to/credentials.txt}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span>;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Option 1 avoids the Nix store, but it is not declarative; we need to manually make sure that the <code>path/to/credentials.txt</code> actually exists.</p>
<p>With option 2, we have Nix manage the file for us, but now it ends up in the Nix store, making it world-readable.</p>
<p>With <code>agenix</code>, we get the best of both worlds. Our configuration looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode nix"><code class="sourceCode nixsyntax"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  age.secrets.myServerCredentials.file = path/to/credentials.age;</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  services.openvpn.myServer.config = <span class="st">&#39;&#39;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="st">    auth-user-pass </span>${config.age.secrets.myServerCredentials.path}</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span>;</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The only thing Nix ever sees is the encrypted <code>.age</code> file, so no unencrypted secrets will end up in the nix store. During early boot, <code>agenix</code> will take the encrypted file out of the nix store, decrypt it, and put it in <code>config.age.secrets.myServerCredentials.path</code> (defaults to <code>/run/secrets/myServerCredentials</code>).</p>
<h1 data-number="2" id="age-and-agenix"><span class="header-section-number">2</span> <code>age</code> and <code>agenix</code></h1>
<p><code>agenix</code> is powered by <a href="https://github.com/FiloSottile/age"><code>age</code></a>. As you want from a cryptographic application, <code>age</code> is extremely light on features (<em>cough</em> PGP <em>cough</em>), but it does have two that make it ideal for this use case: encryption using SSH keys, and multiple recipients. Multiple recipients just means that we encrypt with multiple keys, allowing anyone that has just one of them to decrypt.</p>
<p>You, the user, have an SSH key, and your machines have SSH keys<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Yours is the one typically found in <code>~/.ssh/</code>, and the one for your system is in <code>/etc/ssh/</code> (or reported by <code>ssh-keyscan localhost</code>). <code>agenix</code>’s big insight is that this is all we need to leverage <code>age</code> for robust secret management infrastructure.</p>
<p>When we put a secret in our Nix configuration, we use the <code>agenix</code> command-line tool to encrypt it with both the user’s and the system’s public keys as recipients. This way, the user can still view and edit the keys, and the <code>agenix</code> NixOS module can now decrypt the secrets <em>at boot</em> using the system key, and put them in their desired place.</p>
<h1 data-number="3" id="usage"><span class="header-section-number">3</span> Usage</h1>
<p>Configuration consists of two parts; configuring the NixOS module and configuring the <code>agenix</code> command-line tool, or decryption and encryption, respectively.</p>
<h2 data-number="3.1" id="decryption-nixos-module-configuration"><span class="header-section-number">3.1</span> Decryption: NixOS module configuration</h2>
<p>Start by importing the <code>agenix</code> module into your system configuration, using your Nix dependency-management tool of choice (flakes, channels, niv, <code>builtins.fetchTarball</code>, etc.). We actually already saw the NixOS module’s configuration in its entirety in the OpenVPN example above; set <code>age.secrets.myServerCredentials.file</code>, and read <code>age.secrets.myServerCredentials.path</code>. There’s some additional fields that allow you to control mode flags etc., but the defaults usually work fine. As long as the configured secrets can actually be decrypted with the system’s SSH key, that’s all the setup needed.</p>
<h2 data-number="3.2" id="encryption-the-agenix-cli"><span class="header-section-number">3.2</span> Encryption: The <code>agenix</code> CLI</h2>
<p>Let’s see how we actually encrypt a file.</p>
<ol type="1">
<li><p>Start by making a folder in your Nix config called <code>secrets</code>.</p></li>
<li><p>In the <code>secrets</code> folder, create a file called <code>secrets.nix</code>. <code>secrets.nix</code> contains all relevant public keys, and determines what files are encrypted with what keys. While <code>secrets.nix</code> is a Nix file, it is not in any way actually part of the rest of your NixOS configuration; you never import it or otherwise refer to it in your NixOS configuration. This is the example <code>secrets.nix</code> file from <a href="https://github.com/ryantm/agenix#tutorial">the tutorial</a>:</p></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode nixsyntax"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  user1 = <span class="st">&quot;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIL0idNvgGiucWgup/mP78zyC23uFjYq0evcWdjGQUaBH&quot;</span>;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  user2 = <span class="st">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCoQ9S7V+CufAgwoehnf2TqsJ9LTsu8pUA3FgpS2mdVwcMcTs++8P5sQcXHLtDmNLpWN4k7NQgxaY1oXy5e25x/4VhXaJXWEt3luSw+Phv/PB2+aGLvqCUirsLTAD2r7ieMhd/pcVf/HlhNUQgnO1mupdbDyqZoGD/uCcJiYav8i/V7nJWJouHA8yq31XS2yqXp9m3VC7UZZHzUsVJA9Us5YqF0hKYeaGruIHR2bwoDF9ZFMss5t6/pzxMljU/ccYwvvRDdI7WX4o4+zLuZ6RWvsU6LGbbb0pQdB72tlV41fSefwFsk4JRdKbyV3Xjf25pV4IXOTcqhy+4JTB/jXxrF&quot;</span>;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  users = [ user1 user2 ];</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  system1 = <span class="st">&quot;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPJDyIr/FSz1cJdcoW69R+NrWzwGK/+3gJpqD1t8L2zE&quot;</span>;</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  system2 = <span class="st">&quot;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKzxQgondgEYcLpcPdJLrTdNgZ2gznOHCAxMdaceTUT1&quot;</span>;</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  systems = [ system1 system2 ];</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;secret1.age&quot;</span>.publicKeys = [ user1 system1 ];</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;secret2.age&quot;</span>.publicKeys = users ++ systems;</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="3" type="1">
<li>From the <code>secrets</code> directory, use <code>agenix -e &lt;filename&gt;</code> to edit files. One thing to note is that the system module doesn’t install the <code>agenix</code> executable so you still need to get that somewhere. In my flake-based config I do this:</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode nixsyntax"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>{ environment.systemPackages = [ inputs.agenix.packages.${system}.agenix ]; }</span></code></pre></div>
<p>That’s it! You now have secure declarative management of secrets. The only other thing to be aware of is that you need to rekey your secrets if you change what files have access to them, which is a matter of running <code>agenix --rekey</code>.</p>
<h1 data-number="4" id="caveats"><span class="header-section-number">4</span> Caveats</h1>
<h2 data-number="4.1" id="configuration"><span class="header-section-number">4.1</span> Configuration</h2>
<p>One thing to watch out for is that incorporating your secrets into your config is not always as easy as it is in the OpenVPN example above. You might want to use secrets for options that were not designed to be kept secret, or use <code>agenix</code> for things that aren’t configured through Nix at all.</p>
<p>Two examples from my own config:</p>
<ol type="1">
<li><p>I want to add secret binary caches, but the <code>nix.binaryCaches</code> option only takes strings, it does not take file paths. So, I sidestep the usual cache declaration mechanism and <a href="https://github.com/jonascarpay/nix/blob/0d6fde33df85fe1b97a0fda79299ff4096c38f3d/system/xc-cache.nix#L4">go through <code>nix.extraOptions</code> and the new <code>!include</code> directive</a>.</p></li>
<li><p>AWS credentials aren’t configured through Nix, it relies on a file being present in a designated location in your root/user folder. So, we just override the target path so it <a href="https://github.com/jonascarpay/nix/blob/0d6fde33df85fe1b97a0fda79299ff4096c38f3d/system/xc-cache.nix#L8">writes to <code>/root/.aws/credentials</code> directly</a>.</p></li>
</ol>
<p>The takeaway is that you might encounter situations that require some creativity.</p>
<h2 data-number="4.2" id="some-thoughts-on-security"><span class="header-section-number">4.2</span> Some thoughts on security</h2>
<p>I am not a security expert, the author of <code>agenix</code> <a href="https://github.com/ryantm/agenix#threat-modelwarnings">is not a security expert</a>, so you may be hesitant to trust <code>agenix</code> with your secrets. I’m not here to convince <em>you</em> of anything, but here are some considerations that convinced <em>me</em>.</p>
<p>First of all, the <a href="https://github.com/FiloSottile">author of <code>age</code> itself <em>is</em> a security expert</a>. I found <a href="https://neilmadden.blog/2019/12/30/a-few-comments-on-age/">some discussion of <em>potential</em> attack vectors against <code>age</code></a>, but based on <em>my understanding</em> of <a href="https://moxie.org/2011/12/13/the-cryptographic-doom-principle.html">the underlying reasoning</a>, this would not apply to <code>agenix</code> since we’re not dealing with not high-volume network traffic, all encrypted with the same key.</p>
<p>Second, you can very easily audit <code>agenix</code> yourself, it’s just <a href="https://github.com/ryantm/agenix/blob/master/pkgs/agenix.nix">150 lines of pretty understandable bash in the encryption code</a>, and <a href="https://github.com/ryantm/agenix/blob/master/modules/age.nix">another 100 in the NixOS module</a>.</p>
<p>For what it’s worth, I trust it enough to make my encrypted secrets public and then brag about it in a blog post, so at least if something breaks we’re both screwed.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Provided you have ssh, i.e. <code>services.openssh</code>, enabled. If not, you manually have to specify <code>age.sshKeyPaths</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>More info on the distinction between user and system keys <a href="https://unix.stackexchange.com/questions/439467/what-is-the-difference-between-etc-ssh-and-ssh">here</a>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<div class="header">
	<a href="../index.html">&larr; Back</a>
</div>
<div class="footer">
	<p>
	  questions/suggestions go on
		<a href="https://github.com/jonascarpay/jonascarpay.github.io">a github issue</a>,
		<a href="https://twitter.com/jonascarpay">twitter</a>,
		or <tt>&lt;it's what you think it is&gt;@gmail.com</tt>.
	</p>
	<p>made with pandoc and duct tape.</p>
	<p><a href="/rss.xml">RSS</a></p>
</div>
</body>
</html>
